generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  phone         String?
  cpf           String?
  isAdmin       Boolean   @default(false)

  // Plano e limites
  plan              String    @default("basic")  // basic, pro
  messagesUsedToday Int       @default(0)        // Contador diário
  messagesLimit     Int       @default(30)       // Limite diário (basic=30, pro=150)
  planExpiresAt     DateTime?                    // Data de expiração do plano
  lastResetAt       DateTime  @default(now())    // Última vez que o contador resetou

  // Campos legados (mantidos para compatibilidade)
  messagesUsed  Int       @default(0)

  source        String    @default("manual") // manual, payt, api
  createdAt     DateTime  @default(now())

  conversations Conversation[]
  messages      Message[]
  purchases     PaytPurchase[]
}

model Conversation {
  id        String    @id @default(cuid())
  title     String?
  userId    String
  model     String    @default("google/gemini-2.5-flash")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  role           String
  content        String
  model          String?
  createdAt      DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Settings {
  id    String @id @default(cuid())
  key   String @unique
  value String
}

// Payt Webhook Logs - armazena todos os eventos recebidos
model PaytPurchase {
  id              String   @id @default(cuid())
  transactionId   String   @unique // ID da transação no Payt
  status          String   // paid, canceled, refunded, etc
  type            String   // order, upsell, subscription, etc

  // Dados do cliente
  customerName    String
  customerEmail   String
  customerDoc     String?  // CPF/CNPJ
  customerPhone   String?

  // Dados do produto
  productCode     String?
  productName     String?
  productPrice    Int?     // em centavos

  // Dados da transação
  paymentMethod   String?  // credit_card, boleto, pix
  totalPrice      Int      // em centavos

  // Assinatura (se aplicável)
  subscriptionCode String?
  subscriptionPlan String?

  // Metadados
  rawPayload      String   // JSON completo para debug
  processed       Boolean  @default(false)
  errorMessage    String?

  // Relacionamento com usuário criado
  userId          String?
  user            User?    @relation(fields: [userId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
